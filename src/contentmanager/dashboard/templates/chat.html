{% extends "base.html" %}

{% block title %}Chat - Content Manager{% endblock %}

{% block page_title %}Chat{% endblock %}

{% block head %}
<style>
    .message-bubble {
        max-width: 80%;
        word-wrap: break-word;
    }
    .chat-container {
        height: calc(100vh - 280px);
        min-height: 400px;
    }
    .message-content pre {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .typing-indicator span {
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
    .topic-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .citation-badge {
        font-size: 0.75rem;
        padding: 0.125rem 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="chatApp()" x-init="init()" class="flex h-full">
    <!-- Conversations Sidebar -->
    <div class="w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
        <!-- New Conversation Button -->
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <button @click="startNewConversation()"
                    class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                New Conversation
            </button>
        </div>

        <!-- Conversation List -->
        <div class="flex-1 overflow-y-auto">
            <template x-if="conversations.length === 0">
                <div class="p-4 text-center text-gray-500 dark:text-gray-400">
                    <p class="text-sm">No conversations yet</p>
                    <p class="text-xs mt-1">Start a new conversation to begin</p>
                </div>
            </template>
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                <template x-for="conv in conversations" :key="conv.id">
                    <div @click="selectConversation(conv.id)"
                         :class="currentConversationId === conv.id ? 'bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500' : 'hover:bg-gray-50 dark:hover:bg-gray-700'"
                         class="p-4 cursor-pointer transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white truncate" x-text="conv.title || 'New Conversation'"></p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" x-text="formatDate(conv.updated_at)"></p>
                            </div>
                            <span x-show="conv.message_count > 0"
                                  class="ml-2 px-2 py-0.5 text-xs bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full"
                                  x-text="conv.message_count"></span>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Welcome Screen (when no conversation selected) -->
        <template x-if="!currentConversationId">
            <div class="flex-1 flex items-center justify-center p-8">
                <div class="text-center max-w-lg">
                    <div class="mx-auto h-16 w-16 text-green-600 mb-4">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Welcome to Content Manager Chat</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        Ask questions about the South African Constitution, explore topics, and generate educational content.
                    </p>
                    <div class="grid grid-cols-2 gap-4 max-w-md mx-auto">
                        <button @click="startNewConversation('What rights do I have regarding housing?')"
                                class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-green-500 hover:shadow-md transition-all text-left">
                            <span class="block text-sm font-medium text-gray-900 dark:text-white">Ask a Question</span>
                            <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1">e.g., "What rights do I have?"</span>
                        </button>
                        <button @click="startNewConversation(null, 'suggest_topics')"
                                class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-green-500 hover:shadow-md transition-all text-left">
                            <span class="block text-sm font-medium text-gray-900 dark:text-white">Get Topic Ideas</span>
                            <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1">Discover interesting topics</span>
                        </button>
                        <button @click="startNewConversation('Generate a tweet about the right to equality')"
                                class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-green-500 hover:shadow-md transition-all text-left">
                            <span class="block text-sm font-medium text-gray-900 dark:text-white">Generate Content</span>
                            <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1">Create tweets, threads, scripts</span>
                        </button>
                        <button @click="startNewConversation('Explain Section 9 of the Constitution')"
                                class="p-4 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-green-500 hover:shadow-md transition-all text-left">
                            <span class="block text-sm font-medium text-gray-900 dark:text-white">Explore a Section</span>
                            <span class="block text-xs text-gray-500 dark:text-gray-400 mt-1">Deep dive into any section</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- Chat Messages Area -->
        <template x-if="currentConversationId">
            <div class="flex-1 flex flex-col">
                <!-- Messages Container -->
                <div class="flex-1 overflow-y-auto p-4 chat-container" id="messages-container" x-ref="messagesContainer">
                    <div class="max-w-3xl mx-auto space-y-4">
                        <template x-for="message in messages" :key="message.id">
                            <div :class="message.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                <div :class="message.role === 'user'
                                    ? 'message-bubble bg-green-600 text-white rounded-2xl rounded-br-md px-4 py-3'
                                    : 'message-bubble bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white rounded-2xl rounded-bl-md px-4 py-3'">

                                    <!-- Message Content -->
                                    <div class="message-content prose prose-sm dark:prose-invert max-w-none"
                                         x-html="formatMessageContent(message.content)"></div>

                                    <!-- Topic Suggestions -->
                                    <template x-if="message.message_type === 'topic_suggestion' && message.structured_data?.suggestions">
                                        <div class="mt-3 space-y-2">
                                            <template x-for="(suggestion, idx) in message.structured_data.suggestions" :key="idx">
                                                <div @click="exploreTopic(suggestion.title)"
                                                     class="topic-card p-3 bg-white dark:bg-gray-600 rounded-lg cursor-pointer transition-all">
                                                    <p class="font-medium text-sm text-gray-900 dark:text-white" x-text="suggestion.title"></p>
                                                    <p class="text-xs text-gray-500 dark:text-gray-300 mt-1" x-text="suggestion.angle"></p>
                                                    <div class="flex gap-1 mt-2">
                                                        <template x-for="sec in suggestion.sections" :key="sec">
                                                            <span class="citation-badge bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 rounded">
                                                                Section <span x-text="sec"></span>
                                                            </span>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Generated Content Actions -->
                                    <template x-if="message.message_type === 'generated_content'">
                                        <div class="mt-3 flex gap-2 pt-3 border-t border-gray-200 dark:border-gray-600">
                                            <button @click="refineContent(message.id)"
                                                    class="px-3 py-1.5 text-xs font-medium bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-500 transition-colors">
                                                Refine
                                            </button>
                                            <button @click="finalizeContent(message.id)"
                                                    class="px-3 py-1.5 text-xs font-medium bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                                Add to Queue
                                            </button>
                                        </div>
                                    </template>

                                    <!-- Citations -->
                                    <template x-if="message.citations && message.citations.length > 0">
                                        <div class="mt-2 flex flex-wrap gap-1">
                                            <template x-for="citation in message.citations" :key="citation.section_num">
                                                <span class="citation-badge bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 rounded">
                                                    Section <span x-text="citation.section_num"></span>
                                                </span>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <!-- Loading Indicator -->
                        <div x-show="isLoading" class="flex justify-start">
                            <div class="message-bubble bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-bl-md px-4 py-3">
                                <div class="typing-indicator flex gap-1">
                                    <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                    <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4">
                    <div class="max-w-3xl mx-auto">
                        <!-- Quick Actions -->
                        <div class="flex gap-2 mb-3">
                            <button @click="currentAction = currentAction === 'generate' ? null : 'generate'"
                                    :class="currentAction === 'generate' ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border-green-500' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'"
                                    class="px-3 py-1.5 text-xs font-medium rounded-lg border transition-colors">
                                Generate
                            </button>
                            <select x-show="currentAction === 'generate'"
                                    x-model="contentType"
                                    class="px-3 py-1.5 text-xs bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300">
                                <option value="tweet">Tweet</option>
                                <option value="thread">Thread</option>
                                <option value="script">Script</option>
                            </select>
                            <button @click="suggestTopics()"
                                    :disabled="isLoading"
                                    class="px-3 py-1.5 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors disabled:opacity-50">
                                Get Topic Ideas
                            </button>
                        </div>

                        <!-- Input Field -->
                        <form @submit.prevent="sendMessage()" class="flex gap-3">
                            <input type="text"
                                   x-model="inputMessage"
                                   @keydown.enter.prevent="sendMessage()"
                                   :placeholder="currentAction === 'generate' ? 'Enter a topic to generate content about...' : 'Ask about the Constitution or request content...'"
                                   :disabled="isLoading"
                                   class="flex-1 px-4 py-3 bg-gray-100 dark:bg-gray-700 border-0 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-green-500 disabled:opacity-50">
                            <button type="submit"
                                    :disabled="!inputMessage.trim() || isLoading"
                                    class="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </template>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function chatApp() {
    return {
        conversations: [],
        messages: [],
        currentConversationId: null,
        inputMessage: '',
        isLoading: false,
        currentAction: null,
        contentType: 'tweet',
        refiningMessageId: null,

        async init() {
            await this.loadConversations();
        },

        async loadConversations() {
            try {
                const response = await fetch('/api/chat/conversations');
                if (response.ok) {
                    const data = await response.json();
                    this.conversations = data.conversations;
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
            }
        },

        async selectConversation(conversationId) {
            this.currentConversationId = conversationId;
            this.messages = [];
            this.isLoading = true;

            try {
                const response = await fetch(`/api/chat/conversations/${conversationId}`);
                if (response.ok) {
                    const data = await response.json();
                    this.messages = data.messages;
                    this.$nextTick(() => this.scrollToBottom());
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
                showToast('Failed to load conversation', 'error');
            } finally {
                this.isLoading = false;
            }
        },

        async startNewConversation(initialMessage = null, action = null) {
            this.isLoading = true;

            try {
                const body = {};
                if (initialMessage) {
                    body.initial_message = initialMessage;
                }

                const response = await fetch('/api/chat/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });

                if (response.ok) {
                    const data = await response.json();
                    this.conversations.unshift(data);
                    this.currentConversationId = data.id;
                    this.messages = data.messages;

                    // If action requested but no initial message, trigger the action
                    if (action === 'suggest_topics' && !initialMessage) {
                        await this.suggestTopics();
                    }

                    this.$nextTick(() => this.scrollToBottom());
                }
            } catch (error) {
                console.error('Failed to create conversation:', error);
                showToast('Failed to create conversation', 'error');
            } finally {
                this.isLoading = false;
            }
        },

        async sendMessage() {
            if (!this.inputMessage.trim() || this.isLoading) return;

            const message = this.inputMessage.trim();
            this.inputMessage = '';

            // Add user message to UI immediately
            const tempUserMsg = {
                id: Date.now(),
                role: 'user',
                content: message,
                message_type: 'text',
                created_at: new Date().toISOString(),
            };
            this.messages.push(tempUserMsg);
            this.$nextTick(() => this.scrollToBottom());

            this.isLoading = true;

            try {
                const body = {
                    content: message,
                    message_type: 'text',
                };

                // Add action if set
                if (this.currentAction === 'generate') {
                    body.action = 'generate';
                    body.parameters = { content_type: this.contentType };
                } else if (this.refiningMessageId) {
                    body.action = 'refine';
                    body.parameters = { message_id: this.refiningMessageId };
                }

                const response = await fetch(`/api/chat/conversations/${this.currentConversationId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });

                if (response.ok) {
                    const data = await response.json();
                    this.messages.push(data);
                    this.$nextTick(() => this.scrollToBottom());

                    // Update conversation in list
                    const conv = this.conversations.find(c => c.id === this.currentConversationId);
                    if (conv) {
                        conv.message_count = this.messages.length;
                        conv.updated_at = new Date().toISOString();
                    }
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Failed to send message', 'error');
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                showToast('Failed to send message', 'error');
            } finally {
                this.isLoading = false;
                this.currentAction = null;
                this.refiningMessageId = null;
            }
        },

        async suggestTopics() {
            if (this.isLoading) return;

            this.isLoading = true;

            // Add a user message requesting topics
            const tempUserMsg = {
                id: Date.now(),
                role: 'user',
                content: 'Suggest some topics for me',
                message_type: 'action',
                created_at: new Date().toISOString(),
            };
            this.messages.push(tempUserMsg);
            this.$nextTick(() => this.scrollToBottom());

            try {
                const response = await fetch(`/api/chat/conversations/${this.currentConversationId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: 'Suggest topics',
                        message_type: 'action',
                        action: 'suggest_topics',
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    this.messages.push(data);
                    this.$nextTick(() => this.scrollToBottom());
                }
            } catch (error) {
                console.error('Failed to get suggestions:', error);
                showToast('Failed to get topic suggestions', 'error');
            } finally {
                this.isLoading = false;
            }
        },

        exploreTopic(topic) {
            this.inputMessage = `Tell me more about: ${topic}`;
            this.$refs.messagesContainer?.querySelector('input')?.focus();
        },

        refineContent(messageId) {
            this.refiningMessageId = messageId;
            this.inputMessage = '';
            showToast('Enter your refinement instructions', 'info');
        },

        async finalizeContent(messageId) {
            this.isLoading = true;

            try {
                const response = await fetch(`/api/chat/conversations/${this.currentConversationId}/finalize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message_id: messageId }),
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast(data.message, 'success');

                    // Reload messages to get the action message
                    await this.selectConversation(this.currentConversationId);
                } else {
                    const error = await response.json();
                    showToast(error.detail || 'Failed to add to queue', 'error');
                }
            } catch (error) {
                console.error('Failed to finalize content:', error);
                showToast('Failed to add to queue', 'error');
            } finally {
                this.isLoading = false;
            }
        },

        formatMessageContent(content) {
            // Convert markdown-style formatting to HTML
            let html = content
                // Escape HTML first
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                // Bold
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                // Italic
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                // Code blocks
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-200 dark:bg-gray-600 p-2 rounded mt-2 mb-2 overflow-x-auto"><code>$1</code></pre>')
                // Inline code
                .replace(/`(.+?)`/g, '<code class="bg-gray-200 dark:bg-gray-600 px-1 rounded">$1</code>')
                // Line breaks
                .replace(/\n/g, '<br>');

            return html;
        },

        formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;

            return date.toLocaleDateString();
        },

        scrollToBottom() {
            const container = this.$refs.messagesContainer;
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        },
    };
}
</script>
{% endblock %}
