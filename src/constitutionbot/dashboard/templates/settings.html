{% extends "base.html" %}

{% block title %}Settings - ConstitutionBOT Admin{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<div x-data="settingsData()" x-init="loadSettings()">
    <div class="space-y-8">
        <!-- Twitter Connection -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900">Twitter Connection</h3>
                <p class="mt-1 text-sm text-gray-500">Status of your Twitter API connection</p>

                <div class="mt-4">
                    <div class="rounded-md p-4" :class="twitter.verified ? 'bg-green-50' : (twitter.configured ? 'bg-yellow-50' : 'bg-red-50')">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg x-show="twitter.verified" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                                </svg>
                                <svg x-show="twitter.configured && !twitter.verified" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                                </svg>
                                <svg x-show="!twitter.configured" class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium" :class="twitter.verified ? 'text-green-800' : (twitter.configured ? 'text-yellow-800' : 'text-red-800')">
                                    <span x-show="twitter.verified">Connected</span>
                                    <span x-show="twitter.configured && !twitter.verified">Configuration Issue</span>
                                    <span x-show="!twitter.configured">Not Configured</span>
                                </h3>
                                <p class="text-sm" :class="twitter.verified ? 'text-green-700' : (twitter.configured ? 'text-yellow-700' : 'text-red-700')">
                                    <span x-show="twitter.verified">Twitter API is connected and ready to post.</span>
                                    <span x-show="twitter.configured && !twitter.verified" x-text="twitter.error || 'Unable to verify credentials'"></span>
                                    <span x-show="!twitter.configured">Add Twitter API credentials to your .env file.</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Credentials Status -->
                    <div class="mt-4 grid grid-cols-2 gap-4 sm:grid-cols-5">
                        <div class="text-center p-2 rounded" :class="twitter.credentials?.api_key ? 'bg-green-50' : 'bg-gray-50'">
                            <p class="text-xs text-gray-500">API Key</p>
                            <span :class="twitter.credentials?.api_key ? 'text-green-600' : 'text-gray-400'" x-text="twitter.credentials?.api_key ? '✓' : '✗'"></span>
                        </div>
                        <div class="text-center p-2 rounded" :class="twitter.credentials?.api_secret ? 'bg-green-50' : 'bg-gray-50'">
                            <p class="text-xs text-gray-500">API Secret</p>
                            <span :class="twitter.credentials?.api_secret ? 'text-green-600' : 'text-gray-400'" x-text="twitter.credentials?.api_secret ? '✓' : '✗'"></span>
                        </div>
                        <div class="text-center p-2 rounded" :class="twitter.credentials?.access_token ? 'bg-green-50' : 'bg-gray-50'">
                            <p class="text-xs text-gray-500">Access Token</p>
                            <span :class="twitter.credentials?.access_token ? 'text-green-600' : 'text-gray-400'" x-text="twitter.credentials?.access_token ? '✓' : '✗'"></span>
                        </div>
                        <div class="text-center p-2 rounded" :class="twitter.credentials?.access_secret ? 'bg-green-50' : 'bg-gray-50'">
                            <p class="text-xs text-gray-500">Access Secret</p>
                            <span :class="twitter.credentials?.access_secret ? 'text-green-600' : 'text-gray-400'" x-text="twitter.credentials?.access_secret ? '✓' : '✗'"></span>
                        </div>
                        <div class="text-center p-2 rounded" :class="twitter.credentials?.bearer_token ? 'bg-green-50' : 'bg-gray-50'">
                            <p class="text-xs text-gray-500">Bearer Token</p>
                            <span :class="twitter.credentials?.bearer_token ? 'text-green-600' : 'text-gray-400'" x-text="twitter.credentials?.bearer_token ? '✓' : '✗'"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot Settings -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900">Bot Settings</h3>
                <p class="mt-1 text-sm text-gray-500">Configure the Twitter bot behavior</p>

                <div class="mt-6 space-y-6">
                    <!-- Bot Enabled -->
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-900">Twitter Bot</label>
                            <p class="text-sm text-gray-500">Enable automatic posting of approved content</p>
                        </div>
                        <button @click="settings.bot_enabled = !settings.bot_enabled; saveSettings()"
                                :class="settings.bot_enabled ? 'bg-green-600' : 'bg-gray-200'"
                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            <span :class="settings.bot_enabled ? 'translate-x-5' : 'translate-x-0'"
                                  class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>

                    <!-- Auto Generate -->
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-sm font-medium text-gray-900">Auto-Generate Content</label>
                            <p class="text-sm text-gray-500">Automatically generate content suggestions</p>
                        </div>
                        <button @click="settings.auto_generate_enabled = !settings.auto_generate_enabled; saveSettings()"
                                :class="settings.auto_generate_enabled ? 'bg-green-600' : 'bg-gray-200'"
                                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            <span :class="settings.auto_generate_enabled ? 'translate-x-5' : 'translate-x-0'"
                                  class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                        </button>
                    </div>

                    <!-- Mention Check Interval -->
                    <div>
                        <label class="text-sm font-medium text-gray-900">Mention Check Interval</label>
                        <p class="text-sm text-gray-500">How often to check for new @mentions (seconds)</p>
                        <input type="number" x-model="settings.mention_check_interval" @change="saveSettings()"
                               min="30" max="3600"
                               class="mt-2 block w-32 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                    </div>

                    <!-- Auto Generate Interval -->
                    <div>
                        <label class="text-sm font-medium text-gray-900">Auto-Generate Interval</label>
                        <p class="text-sm text-gray-500">How often to generate new content (seconds)</p>
                        <input type="number" x-model="settings.auto_generate_interval" @change="saveSettings()"
                               min="300" max="86400"
                               class="mt-2 block w-32 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Settings -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <h3 class="text-base font-semibold leading-6 text-gray-900">Content Settings</h3>
                <p class="mt-1 text-sm text-gray-500">Configure content generation defaults</p>

                <div class="mt-6 space-y-4">
                    <div>
                        <label class="text-sm font-medium text-gray-900">Max Tweet Length</label>
                        <p class="text-sm text-gray-500" x-text="settings.max_tweet_length + ' characters'"></p>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-900">Max Thread Tweets</label>
                        <p class="text-sm text-gray-500" x-text="settings.max_thread_tweets + ' tweets'"></p>
                    </div>

                    <div>
                        <label class="text-sm font-medium text-gray-900">Default Hashtags</label>
                        <div class="mt-1 flex flex-wrap gap-1">
                            <template x-for="tag in settings.default_hashtags" :key="tag">
                                <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-1 text-xs font-medium text-green-700" x-text="tag"></span>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function settingsData() {
    return {
        settings: {
            bot_enabled: false,
            mention_check_interval: 60,
            auto_generate_enabled: false,
            auto_generate_interval: 3600,
            max_tweet_length: 280,
            max_thread_tweets: 10,
            default_hashtags: []
        },
        twitter: {
            configured: false,
            verified: false,
            error: null,
            credentials: {}
        },

        async loadSettings() {
            try {
                const [settingsRes, twitterRes] = await Promise.all([
                    fetch('/api/settings'),
                    fetch('/api/settings/twitter-status')
                ]);

                if (settingsRes.ok) {
                    this.settings = await settingsRes.json();
                }
                if (twitterRes.ok) {
                    this.twitter = await twitterRes.json();
                }
            } catch (error) {
                console.error('Failed to load settings:', error);
            }
        },

        async saveSettings() {
            try {
                const response = await fetch('/api/settings', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bot_enabled: this.settings.bot_enabled,
                        mention_check_interval: parseInt(this.settings.mention_check_interval),
                        auto_generate_enabled: this.settings.auto_generate_enabled,
                        auto_generate_interval: parseInt(this.settings.auto_generate_interval)
                    })
                });

                if (response.ok) {
                    showToast('Settings saved', 'success');
                } else {
                    showToast('Failed to save settings', 'error');
                }
            } catch (error) {
                showToast('Failed to save settings', 'error');
            }
        }
    }
}
</script>
{% endblock %}
